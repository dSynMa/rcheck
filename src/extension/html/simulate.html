<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulator: {%=fname%}</title>
    <script type="module" src="{%= elementsUri %}"></script>
</head>

<body>
    <h1>R-CHECK simulator: {%=fname%}</h1>
    <vscode-form-group>
        <vscode-label for="select-transition">Transition:</vscode-label>
        <vscode-single-select id="select-transition"></vscode-single-select>
        <vscode-button onclick="next()">Next</vscode-button>
        <vscode-button secondary onclick="back()">Back</vscode-button>
    </vscode-form-group>
    <vscode-table zebra bordered-rows resizable columns='["15%", "85%"]' min-column-width="5px">
        <vscode-table-header slot="header">
            <vscode-table-header-cell>#</vscode-table-header-cell>
            <vscode-table-header-cell>State</vscode-table-header-cell>
        </vscode-table-header>
        <vscode-table-body slot="body" id="steps"></vscode-table-body>
    </vscode-table>
<script>
const vscode = acquireVsCodeApi();
const select = document.getElementById("select-transition");
const steps = document.getElementById("steps");
let counter = 0;
function next() { vscode.postMessage({ command: 'next', data: select.value }); }
function back() { vscode.postMessage({ command: 'back' }); }


window.addEventListener('message', event => {
    const message = event.data;
    switch (message.command) {
        case 'undo-step':
            if (steps.firstChild) { steps.removeChild(steps.lastChild); }
            if (steps.firstChild) { steps.removeChild(steps.lastChild); }
            counter -= 1;
            break;
        case 'append-step':
            if (message.content.hasOwnProperty("inboundTransition")) {
                const row = document.createElement("vscode-table-row");
                row.appendChild(document.createElement("vscode-table-cell"));
                const cell = document.createElement("vscode-table-cell");
                cell.textContent = JSON.stringify(message.content.inboundTransition);
                row.appendChild(cell);
                steps.appendChild(row);
            }
            const row = document.createElement("vscode-table-row");
            const cell1 = document.createElement("vscode-table-cell");
            const cell2 = document.createElement("vscode-table-cell");
            counter += 1;
            cell1.textContent = counter;
            cell2.textContent = JSON.stringify(message.content.state);
            row.appendChild(cell1);
            row.appendChild(cell2);
            steps.appendChild(row);
            break;
        case 'update-transitions':
            while (select.firstChild) { select.removeChild(select.lastChild); }
            for (let index = 0; index < message.content.length; index++) {
                const element = message.content[index];
                const option = document.createElement("vscode-option");
                option.setAttribute("description", element.send)
                option.setAttribute("value", index);
                option.textContent = element.sender + '-> {' + element.receivers.join(", ") + '}';
                select.appendChild(option);
            }
            break;
    }
});
</script>
</body>

</html>